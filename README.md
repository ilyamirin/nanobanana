# nanobanana

Инструменты для генерации изображений с помощью модели `google/nano-banana` через Replicate API. Первая цель — настроить клиента и проверить подключение.

## Быстрый старт

1) Установите зависимости:
```
pip install -r requirements.txt
```

2) Скопируйте пример переменных окружения и укажите ваш токен Replicate:
```
cp .env.example .env
# Откройте .env и вставьте свой токен в REPLICATE_API_TOKEN
```

3) Проверьте подключение к Replicate и доступ к модели `google/nano-banana`:
```
python scripts/check_replicate_connection.py
```
При успешном подключении увидите что-то вроде:
```
Connection OK ✅
Model: google/nano-banana
Latest version: <версия>
```

## Конфигурация
- Токен хранится в переменной окружения `REPLICATE_API_TOKEN` (подгружается из файла `.env` через `python-dotenv`).
- Файл `.env` добавлен в `.gitignore`, чтобы не коммитить секреты. Пример находится в `.env.example`.

## Структура
- `nanobanana_app/config.py` — загрузка конфигурации/токена.
- `nanobanana_app/replicate_client.py` — инициализация клиента Replicate и доступ к модели `google/nano-banana`.
- `scripts/check_replicate_connection.py` — скрипт проверки подключения.

## Дальше
Следующим шагом будет добавление интерфейса на Streamlit для генерации изображений с помощью `nano-banana`, используя уже настроенный клиент Replicate.

## Streamlit UI

Интерфейс Streamlit позволяет настраивать ВСЕ доступные параметры модели `google/nano-banana`:
- Параметры автоматически подтягиваются из OpenAPI-схемы модели (если доступна).
- Для любых дополнительных/неизвестных параметров есть редактор JSON.
- Результаты генерации сохраняются в папку `outputs/` и одновременно отображаются в UI.

Запуск:
```
streamlit run streamlit_app.py
```

Требования:
- Установлены зависимости из `requirements.txt`.
- Переменная `REPLICATE_API_TOKEN` задана (через `.env` или окружение).

Поведение и советы:
- Поля `prompt`/`text` выводятся первыми для удобства.
- Если API модели не раскрывает схему входов, используйте блок "JSON‑параметры".
- Выходные изображения скачиваются в `outputs/` (эта папка добавлена в `.gitignore`).

## Пакетная загрузка промптов (Markdown/CSV)

Теперь приложение поддерживает пакетный импорт промптов из Markdown и CSV, а также пакетную генерацию изображений.

Где это в UI:
- В сайдбаре откройте раздел "Пакетная загрузка" и загрузите `.md/.markdown` или `.csv` файл.
- После импорта ниже в центре появится блок "Пакетная генерация" с предпросмотром записей и кнопкой запуска.

Поддерживаемые форматы Markdown:
1) Таблица (GitHub‑style). Первый ряд — заголовки колонок. Пример:

```
| № | Название | Промпт |
|---|----------|--------|
| 0 | Начало без цели | Мягкая эко‑сюрреалистическая иллюстрация... |
```

2) JSON‑блоки в кодовых блоках. Каждый блок — объект с полем `prompt` (или `text`/`caption`):

```json
{ "title": "Начало без цели", "prompt": "Мягкая эко‑сюрреалистическая иллюстрация..." }
```

Поддерживаемые поля/заголовки:
- Название: `Имя`, `Название`, `Название карты`, `Заголовок`, `title`, `name`, `№` (любой из них попадёт в `title`).
- Текст/промпт: `Промпт`, `Промпт для генерации`, `Промпт для генерации (на русском)`, `prompt`, `text`, `caption`, а также резервно `Описание`/`Ключевой образ / жест`.

CSV:
- Для CSV импортера заголовки колонок можно сопоставить вручную (всплывающий блок "Настройка колонок CSV").
- В качестве примера можно использовать файл `старшие арканы.csv` из корня проекта.

Как это работает при запуске пакета:
- Все текущие параметры формы (числа, чекбоксы, др.) используются как общие.
- Для каждой записи из файла подставляется свой `prompt` в поле модели (`prompt`/`text`/`caption` — определяется автоматически по схеме).
- Если в файле есть колонка размера (`Размер`/`size`/`aspect ratio` и др.), то для этой записи размер берётся из неё и переопределяет значение из формы. Поддерживаются форматы: `9:16`, `16:9`, `1:1`, `1024x576`/`1024×576`, а также слова `portrait`/`landscape`/`square` и их русские аналоги.
- Файлы сохраняются с названием на основе `title` (приоритет: поле `Имя`/`Название`/`Название карты`; если пусто — берётся индекс). Поддерживаются Unicode‑имена файлов (кириллица и др.).


## Варианты на один промпт

В одиночной генерации можно указать, сколько вариантов изображений получить для одного и того же промпта:
- В центре экрана перед кнопкой «Сгенерировать» есть поле «Количество экспериментов (вариантов на 1 промпт)».
- Значение от 1 до 10. По умолчанию 1.
- Если модель поддерживает параметр вроде `num_outputs`/`num_samples`, он будет выставлен напрямую. Иначе приложение выполнит несколько запусков подряд и соберёт все изображения в одну галерею.
